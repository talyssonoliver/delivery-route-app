<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöö Route Generator - Simplified & Working</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #4299e1;
            --primary-dark: #3182ce;
            --success: #38b2ac;
            --warning: #f39c12;
            --error: #e53e3e;
            --gray-50: #f7fafc;
            --gray-100: #edf2f7;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e0;
            --gray-600: #718096;
            --gray-800: #2d3748;
            --gray-900: #1a202c;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .card { 
            background: white; 
            border-radius: 16px; 
            padding: 24px; 
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 { 
            font-size: clamp(20px, 5vw, 28px);
            margin-bottom: 8px; 
            color: var(--gray-900);
            font-weight: 700;
        }
        h2 {
            font-size: clamp(16px, 4vw, 20px);
            margin-bottom: 16px;
            color: var(--gray-800);
            font-weight: 600;
        }
        .subtitle { 
            color: var(--gray-600); 
            font-size: 14px; 
            margin-bottom: 16px; 
        }
        .btn {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:disabled { 
            background: var(--gray-300);
            cursor: not-allowed; 
            opacity: 0.6;
        }
        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        .btn-primary:hover:not(:disabled) { 
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        .btn-secondary { 
            background: var(--gray-200); 
            color: var(--gray-800); 
            margin-top: 8px; 
        }
        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            background: var(--gray-50);
        }
        input[type="password"] {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
            font-family: 'Monaco', monospace;
        }
        .alert {
            padding: 14px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .alert-warning { 
            background: #fef5e7; 
            border-left: 4px solid var(--warning); 
            color: #875a0f; 
        }
        .alert-error { 
            background: #fee; 
            border-left: 4px solid var(--error); 
            color: #742a2a; 
        }
        .alert-success { 
            background: #e6fffa; 
            border-left: 4px solid var(--success); 
            color: #234e52; 
        }
        .alert-info {
            background: #ebf8ff;
            border-left: 4px solid var(--primary);
            color: #2c5282;
        }
        .progress {
            width: 100%;
            height: 10px;
            background: var(--gray-200);
            border-radius: 5px;
            overflow: hidden;
            margin: 16px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, #667eea 100%);
            transition: width 0.3s ease;
        }
        .image-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 12px;
        }
        .image-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--gray-50);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .remove-btn {
            color: var(--error);
            cursor: pointer;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .route-card {
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .badge {
            background: #ebf8ff;
            color: #2c5282;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
        }
        .address-list {
            max-height: 300px;
            overflow-y: auto;
            background: var(--gray-50);
            padding: 16px;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 12px;
            display: none;
        }
        .address-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
        }
        .show-addresses {
            cursor: pointer;
            color: var(--primary);
            font-size: 14px;
            margin-top: 12px;
            user-select: none;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 28px;
            max-width: 500px;
            width: 90%;
        }
        .hidden { display: none !important; }
        .debug-panel {
            background: #1a202c;
            color: #48bb78;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Monaco', monospace;
            font-size: 11px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 16px;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üöö Route Generator - Simplified</h1>
            <div class="subtitle">Simple, Direct, and Actually Works!</div>
            <div id="apiKeyStatus"></div>
        </div>

        <div class="card">
            <h2>1. Upload Run Sheet Images</h2>
            <input type="file" id="imageInput" multiple accept="image/*,application/pdf">
            <div id="imageList" class="image-list"></div>
        </div>

        <button id="processBtn" class="btn btn-primary" disabled>
            üß† Extract Addresses
        </button>

        <div id="progressSection" class="hidden">
            <div class="card">
                <div id="progressText" style="text-align: center; margin-bottom: 8px; font-size: 14px; font-weight: 500;"></div>
                <div class="progress">
                    <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                </div>
                <div id="debugPanel" class="debug-panel hidden"></div>
            </div>
        </div>

        <div id="errorSection" class="hidden">
            <div class="alert alert-error">
                <span>‚ö†Ô∏è</span>
                <div id="errorText"></div>
            </div>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="card">
                <h2 id="resultsTitle"></h2>
                <div id="routesList"></div>
            </div>
        </div>
    </div>

    <div id="apiKeyModal" class="modal">
        <div class="modal-content">
            <h3 style="font-size: 20px; margin-bottom: 12px;">üîë Anthropic API Key</h3>
            <p style="font-size: 13px; color: var(--gray-600); margin-bottom: 16px;">
                Get your free key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>
            </p>
            <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-...">
            <button class="btn btn-primary" onclick="saveApiKey()">Save Key</button>
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        'use strict';
        
        let images = [];
        let apiKey = localStorage.getItem('anthropic_api_key') || '';
        let isProcessing = false;

        // SIMPLIFIED PROMPT - Direct and Clear
        const SIMPLE_PROMPT = `Look at this UK delivery run sheet image.

Extract ALL delivery addresses. For EACH delivery:

1. Find the stop number
2. Find the FULL address (include everything: building, street, area, postcode)
3. Remove person names (keep business names)
4. Remove metadata like "Del Weight:", "Signature:", "Contact:", "Remarks:"

UK Postcodes look like: HA6 2WQ, HA5 3PB, NW1 8XE, NW5 2NL

Return ONLY this JSON format (NO markdown, NO explanation):

[
  {"num": 9, "address": "10 Cullera Close, Northwood, Middlesex HA6 3SE GB"},
  {"num": 10, "address": "15 Asteria Place, Eastbury Avenue, Northwood, Middlesex HA6 3FL GB"}
]

Extract ALL stops you can see. Include " GB" at the end of each address.`;

        // UK POSTCODE REGEX
        const UK_POSTCODE_REGEX = /\b([A-Z]{1,2}\d{1,2}[A-Z]?)\s*(\d[A-Z]{2})\b/gi;
        
        function isValidUKPostcode(postcode) {
            if (!postcode) return false;
            return /^[A-Z]{1,2}\d{1,2}[A-Z]?\s*\d[A-Z]{2}$/i.test(postcode.trim());
        }

        // NAME REMOVAL
        function removeName(address) {
            // Remove "Mr/Mrs/Ms/Miss/Dr + Name"
            address = address.replace(/\b(Mr|Mrs|Ms|Miss|Dr|Prof)\.?\s+[A-Z][a-z]+\s+[A-Z][a-z]+,?\s*/gi, '');
            // Remove "FIRSTNAME LASTNAME,"
            address = address.replace(/^[A-Z][a-z]+\s+[A-Z][a-z]+,?\s*/, '');
            // Remove "ALL CAPS NAME,"
            address = address.replace(/^[A-Z\s]+,\s*/, '');
            return address.trim();
        }

        // CLEANUP
        function cleanAddress(address) {
            if (!address) return '';
            
            // Remove names
            address = removeName(address);
            
            // Remove metadata keywords
            const keywords = ['Del Weight:', 'Del Items:', 'Deadline:', 'Signature:', 'Contact Nos:', 'Ref:', 'Remarks:'];
            keywords.forEach(kw => {
                const regex = new RegExp(kw.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&') + '\\s*[^,]*', 'gi');
                address = address.replace(regex, '');
            });
            
            // Remove stop number prefix
            address = address.replace(/^\d+\.\s*\|?\s*/, '');
            
            // Clean whitespace
            address = address.replace(/\s+/g, ' ');
            address = address.replace(/,\s*,+/g, ',');
            address = address.replace(/^\s*,+|,+\s*$/g, '');
            address = address.trim();
            
            // Ensure GB suffix
            if (!address.toUpperCase().endsWith(' GB')) {
                address += ' GB';
            }
            
            return address;
        }

        // DEBUG LOG
        function debugLog(message) {
            const panel = document.getElementById('debugPanel');
            panel.classList.remove('hidden');
            panel.textContent += `\n${message}`;
            panel.scrollTop = panel.scrollHeight;
        }

        // CLAUDE VISION
        async function processWithClaude(base64, mediaType, filename) {
            debugLog(`\nüì∏ Processing: ${filename}`);
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4000,
                        temperature: 0,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: { type: 'base64', media_type: mediaType, data: base64 }
                                },
                                {
                                    type: 'text',
                                    text: SIMPLE_PROMPT
                                }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || `API error: ${response.status}`);
                }

                const data = await response.json();
                const text = data.content[0].text;
                
                debugLog(`‚úÖ Response received (${text.length} chars)`);
                debugLog(`üìÑ Raw response:\n${text.substring(0, 500)}...`);
                
                return text;
                
            } catch (error) {
                debugLog(`‚ùå Error: ${error.message}`);
                throw error;
            }
        }

        // PARSE RESPONSE
        function parseResponse(text) {
            debugLog('\nüîç Parsing response...');
            
            // Remove markdown
            text = text.replace(/```json\s*/g, '').replace(/```\s*/g, '');
            
            // Find JSON array
            const jsonMatch = text.match(/\[[\s\S]*\]/);
            if (!jsonMatch) {
                debugLog('‚ùå No JSON array found');
                throw new Error('No JSON found in response');
            }
            
            try {
                const stops = JSON.parse(jsonMatch[0]);
                debugLog(`‚úÖ Parsed ${stops.length} stops`);
                return stops;
            } catch (e) {
                debugLog(`‚ùå JSON parse error: ${e.message}`);
                throw new Error('Invalid JSON');
            }
        }

        // VALIDATE
        function validateStops(stops) {
            debugLog(`\nüîß Validating ${stops.length} stops...`);
            
            const valid = [];
            
            stops.forEach(stop => {
                if (!stop.num || !stop.address) {
                    debugLog(`‚ö†Ô∏è Skip: missing num/address`);
                    return;
                }
                
                let address = cleanAddress(stop.address);
                
                // Check for UK postcode
                const hasPostcode = UK_POSTCODE_REGEX.test(address);
                if (!hasPostcode) {
                    debugLog(`‚ö†Ô∏è Skip stop ${stop.num}: no UK postcode`);
                    return;
                }
                
                valid.push({
                    num: parseInt(stop.num),
                    address: address
                });
                
                debugLog(`‚úÖ Valid: ${stop.num}`);
            });
            
            debugLog(`‚úÖ ${valid.length} valid stops`);
            return valid;
        }

        // FILE TO BASE64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        resolve(reader.result.split(',')[1]);
                    } catch (e) {
                        reject(new Error('Failed to encode'));
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }

        // MAIN PROCESS
        async function processImages() {
            if (images.length === 0) {
                showError('Please upload at least one image');
                return;
            }

            if (!apiKey || !apiKey.startsWith('sk-ant-')) {
                showError('Please add a valid API key first');
                showApiKeyModal();
                return;
            }

            isProcessing = true;
            updateProcessButton();
            
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('debugPanel').textContent = 'üöÄ Starting processing...';
            
            const allStops = [];
            let failed = 0;

            try {
                for (let i = 0; i < images.length; i++) {
                    const progress = ((i + 1) / images.length) * 100;
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressText').textContent = 
                        `Processing ${i + 1}/${images.length}: ${images[i].name}`;

                    try {
                        const base64 = await fileToBase64(images[i]);
                        const response = await processWithClaude(base64, images[i].type, images[i].name);
                        const parsed = parseResponse(response);
                        const valid = validateStops(parsed);
                        
                        if (valid.length > 0) {
                            allStops.push(...valid);
                            debugLog(`\n‚úÖ Image ${i + 1}: ${valid.length} addresses extracted`);
                        } else {
                            failed++;
                            debugLog(`\n‚ö†Ô∏è Image ${i + 1}: No valid addresses`);
                        }
                        
                    } catch (err) {
                        failed++;
                        debugLog(`\n‚ùå Image ${i + 1} failed: ${err.message}`);
                        
                        if (err.message.includes('authentication') || err.message.includes('API key')) {
                            throw err;
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                if (allStops.length === 0) {
                    throw new Error('No addresses extracted from any image. Check debug panel for details.');
                }

                // Deduplicate and sort
                const unique = allStops
                    .filter((s, i, self) => i === self.findIndex(x => x.num === s.num && x.address === s.address))
                    .sort((a, b) => a.num - b.num);

                debugLog(`\n‚úÖ TOTAL: ${unique.length} unique addresses`);

                // Group into routes
                const groups = [];
                const maxPer = 14;
                
                for (let i = 0; i < unique.length; i += maxPer) {
                    const group = unique.slice(i, Math.min(i + maxPer, unique.length));
                    const dests = group.map(s => encodeURIComponent(s.address)).join('&daddr=');
                    groups.push({
                        id: Math.floor(i / maxPer) + 1,
                        startStop: group[0].num,
                        endStop: group[group.length - 1].num,
                        count: group.length,
                        stops: group,
                        link: `https://maps.apple.com/?daddr=${dests}`
                    });
                }

                displayResults(groups, unique.length);

            } catch (err) {
                debugLog(`\n‚ùå FATAL: ${err.message}`);
                showError(err.message);
            } finally {
                isProcessing = false;
                document.getElementById('progressSection').classList.add('hidden');
                updateProcessButton();
            }
        }

        // UI FUNCTIONS
        function updateApiKeyStatus() {
            const statusDiv = document.getElementById('apiKeyStatus');
            if (apiKey && apiKey.startsWith('sk-ant-')) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <span>‚úì</span>
                        <span>API Key configured</span>
                        <button onclick="showApiKeyModal()" 
                                style="background: var(--success); color: white; border: none; padding: 4px 12px; border-radius: 6px; cursor: pointer; margin-left: auto; font-size: 12px; font-weight: 600;">
                            Change
                        </button>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <span>‚ö†Ô∏è</span>
                        <span>API Key required</span>
                        <button onclick="showApiKeyModal()" 
                                style="background: var(--warning); color: white; border: none; padding: 6px 16px; border-radius: 6px; cursor: pointer; margin-left: auto; font-weight: 600;">
                            Add Key
                        </button>
                    </div>
                `;
            }
            updateProcessButton();
        }

        function updateImageList() {
            const listDiv = document.getElementById('imageList');
            if (images.length === 0) {
                listDiv.innerHTML = '';
                return;
            }
            const header = document.createElement('div');
            header.style.cssText = 'color: var(--success); font-size: 14px; margin-bottom: 12px; font-weight: 600;';
            header.textContent = `‚úì ${images.length} file(s) selected`;
            listDiv.innerHTML = '';
            listDiv.appendChild(header);
            
            images.forEach((img, idx) => {
                const item = document.createElement('div');
                item.className = 'image-item';
                item.innerHTML = `
                    <span style="flex: 1; overflow: hidden; text-overflow: ellipsis;">${img.name}</span>
                    <span style="font-size: 11px; color: var(--gray-600); margin-right: 12px;">${formatFileSize(img.size)}</span>
                    <button class="remove-btn" onclick="removeImage(${idx})">Remove</button>
                `;
                listDiv.appendChild(item);
            });
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function removeImage(idx) {
            images.splice(idx, 1);
            updateImageList();
            updateProcessButton();
        }

        function updateProcessButton() {
            const btn = document.getElementById('processBtn');
            btn.disabled = !(images.length > 0 && apiKey && apiKey.startsWith('sk-ant-') && !isProcessing);
        }

        function showApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'flex';
            document.getElementById('apiKeyInput').value = apiKey;
        }

        function closeModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key.startsWith('sk-ant-')) {
                showError('Invalid API key. Must start with "sk-ant-"');
                return;
            }
            apiKey = key;
            localStorage.setItem('anthropic_api_key', key);
            updateApiKeyStatus();
            closeModal();
            showSuccess('‚úì API key saved');
        }

        function displayResults(groups, total) {
            document.getElementById('resultsTitle').textContent = `‚úì ${total} Addresses Extracted`;
            const list = document.getElementById('routesList');
            list.innerHTML = '';

            groups.forEach(g => {
                const card = document.createElement('div');
                card.className = 'route-card';
                card.innerHTML = `
                    <div class="route-header">
                        <div>
                            <div style="font-weight: 600; font-size: 18px;">Route ${g.id}</div>
                            <div style="color: var(--gray-600); font-size: 13px;">Stops ${g.startStop}-${g.endStop}</div>
                        </div>
                        <div class="badge">${g.count} stops</div>
                    </div>
                    <a href="${g.link}" target="_blank" class="btn btn-primary" style="text-decoration: none;">
                        üó∫Ô∏è Open in Apple Maps
                    </a>
                    <button class="btn btn-secondary" onclick="copyLink('${g.link.replace(/'/g, "\\'")}')">
                        üìã Copy Link
                    </button>
                    <div class="show-addresses" onclick="toggleAddresses(this)">‚ñº Show ${g.count} addresses</div>
                    <div class="address-list">
                        ${g.stops.map(s => `
                            <div class="address-item">
                                <strong style="color: var(--primary);">${s.num}.</strong> ${s.address}
                            </div>
                        `).join('')}
                    </div>
                `;
                list.appendChild(card);
            });

            document.getElementById('resultsSection').classList.remove('hidden');
        }

        function toggleAddresses(el) {
            const list = el.nextElementSibling;
            if (list.style.display === 'block') {
                list.style.display = 'none';
                el.textContent = el.textContent.replace('‚ñ≤', '‚ñº');
            } else {
                list.style.display = 'block';
                el.textContent = el.textContent.replace('‚ñº', '‚ñ≤');
            }
        }

        function copyLink(link) {
            navigator.clipboard.writeText(link)
                .then(() => showSuccess('‚úì Link copied'))
                .catch(() => showError('Failed to copy'));
        }

        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            document.getElementById('errorText').textContent = message;
            errorSection.classList.remove('hidden');
        }

        function showSuccess(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-success';
            alert.innerHTML = `<span>‚úì</span><span>${message}</span>`;
            alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        // EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', () => {
            updateApiKeyStatus();
            
            document.getElementById('imageInput').addEventListener('change', (e) => {
                images = Array.from(e.target.files).filter(f => 
                    (f.type.startsWith('image/') || f.type === 'application/pdf') && f.size <= 10485760
                );
                updateImageList();
                updateProcessButton();
            });
            
            document.getElementById('processBtn').addEventListener('click', processImages);
            
            document.getElementById('apiKeyModal').addEventListener('click', (e) => {
                if (e.target.id === 'apiKeyModal') closeModal();
            });
        });
    </script>
</body>
</html>