<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>üß† Ultra Robust Route Generator v3.4 (CDN Diagnostics)</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#4299e1;--primary-dark:#3182ce;--secondary:#667eea;--success:#38b2ac;--warning:#f39c12;--error:#e53e3e;
      --gray-50:#f7fafc;--gray-100:#edf2f7;--gray-200:#e2e8f0;--gray-300:#cbd5e0;--gray-600:#718096;--gray-800:#2d3748;--gray-900:#1a202c}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;line-height:1.6}
    .container{max-width:1000px;margin:0 auto}
    .card{background:#fff;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    h1{font-size:28px;margin-bottom:8px;color:var(--gray-900);font-weight:700}
    h2{font-size:20px;margin-bottom:16px;color:var(--gray-800);font-weight:600}
    .alert{padding:14px 16px;border-radius:8px;margin-bottom:16px;font-size:14px}
    .alert-warning{background:#fef5e7;border-left:4px solid var(--warning);color:#875a0f}
    .alert-error{background:#fee;border-left:4px solid var(--error);color:#742a2a}
    .alert-success{background:#e6fffa;border-left:4px solid var(--success);color:#234e52}
    .alert-info{background:#ebf8ff;border-left:4px solid var(--primary);color:#2c5282}
    .btn{padding:14px 20px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all .2s ease;margin-right:10px;margin-bottom:10px}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-success{background:var(--success);color:#fff}
    .diagnostic-result{background:var(--gray-50);padding:16px;border-radius:8px;margin:12px 0;font-family:monospace;font-size:13px}
    .status-indicator{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px}
    .status-pass{background:var(--success)}
    .status-fail{background:var(--error)}
    .status-pending{background:var(--warning)}
    pre{background:#1a202c;color:#48bb78;padding:16px;border-radius:8px;overflow-x:auto;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üîß OCR Diagnostic Tool</h1>
      <div class="alert alert-info">
        This diagnostic tool will help identify why Tesseract.js is failing to load. Run the tests below to troubleshoot.
      </div>

```
  <h2>Quick Diagnostics</h2>
  <button onclick="runAllDiagnostics()" class="btn btn-primary">üîç Run All Diagnostics</button>
  <button onclick="testCDN()" class="btn btn-primary">Test CDN Access</button>
  <button onclick="testWorkerSupport()" class="btn btn-primary">Test Web Worker Support</button>
  <button onclick="testTesseractLoad()" class="btn btn-primary">Test Tesseract Load</button>
  
  <div id="diagnosticResults" style="margin-top:20px"></div>
</div>

<div class="card">
  <h2>Recommended Solutions</h2>
  <div id="recommendations"></div>
</div>

<div class="card">
  <h2>Manual Test (No OCR)</h2>
  <p style="margin-bottom:12px;color:var(--gray-600)">Test address parsing without OCR to verify core functionality:</p>
  <textarea id="manualInput" style="width:100%;min-height:150px;padding:12px;border:1px solid var(--gray-300);border-radius:6px;font-family:monospace;font-size:13px" placeholder="Paste addresses here (UK postcodes required)..."></textarea>
  <button onclick="testManualParsing()" class="btn btn-success" style="margin-top:12px">Test Address Parsing</button>
  <div id="manualResults"></div>
</div>

<div class="card">
  <h2>Environment Information</h2>
  <pre id="envInfo">Loading...</pre>
</div>
```

  </div>

  <script>
    'use strict';

    // Display environment info immediately
    document.getElementById('envInfo').textContent = JSON.stringify({
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      language: navigator.language,
      online: navigator.onLine,
      cookieEnabled: navigator.cookieEnabled,
      doNotTrack: navigator.doNotTrack,
      hardwareConcurrency: navigator.hardwareConcurrency,
      maxTouchPoints: navigator.maxTouchPoints,
      vendor: navigator.vendor,
      webdriver: navigator.webdriver,
      location: window.location.href,
      protocol: window.location.protocol,
      host: window.location.host,
      localStorage: typeof localStorage !== 'undefined',
      sessionStorage: typeof sessionStorage !== 'undefined',
      indexedDB: typeof indexedDB !== 'undefined',
      serviceWorker: 'serviceWorker' in navigator,
      webWorker: typeof Worker !== 'undefined',
      sharedWorker: typeof SharedWorker !== 'undefined'
    }, null, 2);

    function addResult(title, status, message, details = null) {
      const results = document.getElementById('diagnosticResults');
      const statusClass = status === 'pass' ? 'status-pass' : status === 'fail' ? 'status-fail' : 'status-pending';
      const statusText = status === 'pass' ? '‚úÖ' : status === 'fail' ? '‚ùå' : '‚è≥';
      
      const resultDiv = document.createElement('div');
      resultDiv.className = 'diagnostic-result';
      resultDiv.innerHTML = `
        <div style="font-weight:600;margin-bottom:8px">
          <span class="status-indicator ${statusClass}"></span>
          ${statusText} ${title}
        </div>
        <div style="color:var(--gray-600)">${message}</div>
        ${details ? `<pre style="margin-top:8px;font-size:11px">${details}</pre>` : ''}

```
  `;
  results.appendChild(resultDiv);
  return resultDiv;
}

function addRecommendation(text) {
  const recs = document.getElementById('recommendations');
  const rec = document.createElement('div');
  rec.className = 'alert alert-warning';
  rec.innerHTML = `<span>üí°</span><span>${text}</span>`;
  recs.appendChild(rec);
}

async function testCDN() {
  document.getElementById('diagnosticResults').innerHTML = '';
  document.getElementById('recommendations').innerHTML = '';
  
  addResult('CDN Access Test', 'pending', 'Testing access to jsdelivr CDN...', null);

  try {
    // Test multiple CDN endpoints
    const cdns = [
      'https://cdn.jsdelivr.net/npm/tesseract.js@5.0.5/dist/tesseract.min.js',
      'https://unpkg.com/tesseract.js@v5.0.5/dist/tesseract.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.5/tesseract.min.js'
    ];

    for (const cdn of cdns) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const response = await fetch(cdn, { 
          method: 'HEAD',
          signal: controller.signal 
        });
        clearTimeout(timeoutId);
        
        if (response.ok) {
          addResult(
            'CDN Access', 
            'pass', 
            `Successfully connected to: ${new URL(cdn).hostname}`,
            `Status: ${response.status} ${response.statusText}\nURL: ${cdn}`
          );
          return true;
        }
      } catch (err) {
        addResult(
          'CDN Test', 
          'fail', 
          `Failed to access: ${new URL(cdn).hostname}`,
          `Error: ${err.message}\nURL: ${cdn}`
        );
      }
    }

    addRecommendation('All CDN endpoints are inaccessible. This could be due to:<br>1. Network/firewall restrictions<br>2. Corporate proxy blocking CDNs<br>3. Offline/poor internet connection<br>4. DNS issues<br><br><strong>Solution:</strong> Download Tesseract.js and host it locally with your app.');
    return false;

  } catch (err) {
    addResult('CDN Access Test', 'fail', `Error testing CDN access: ${err.message}`, err.stack);
    return false;
  }
}

async function testWorkerSupport() {
  addResult('Web Worker Support', 'pending', 'Checking browser support for Web Workers...', null);

  try {
    if (typeof Worker === 'undefined') {
      addResult('Web Worker Support', 'fail', 'Web Workers are not supported in this environment', null);
      addRecommendation('Your browser or environment does not support Web Workers, which are required for Tesseract.js. Try:<br>1. Using a modern browser (Chrome, Firefox, Safari, Edge)<br>2. Enabling JavaScript<br>3. Checking if you\'re in a restricted iframe');
      return false;
    }

    // Try to create a simple worker
    const blob = new Blob(['self.postMessage("test");'], { type: 'application/javascript' });
    const url = URL.createObjectURL(blob);
    const worker = new Worker(url);

    return new Promise((resolve) => {
      const timeout = setTimeout(() => {
        worker.terminate();
        addResult('Web Worker Support', 'fail', 'Worker created but timed out', null);
        addRecommendation('Web Workers can be created but are timing out. This might be a security restriction.');
        resolve(false);
      }, 5000);

      worker.onmessage = () => {
        clearTimeout(timeout);
        worker.terminate();
        URL.revokeObjectURL(url);
        addResult('Web Worker Support', 'pass', 'Web Workers are fully supported', null);
        resolve(true);
      };

      worker.onerror = (err) => {
        clearTimeout(timeout);
        worker.terminate();
        URL.revokeObjectURL(url);
        addResult('Web Worker Support', 'fail', 'Worker creation failed', err.message);
        addRecommendation('Web Worker creation failed. Check browser console for CSP (Content Security Policy) errors.');
        resolve(false);
      };
    });

  } catch (err) {
    addResult('Web Worker Support', 'fail', `Error: ${err.message}`, err.stack);
    addRecommendation('Failed to test Web Worker support. This suggests a severe browser restriction or compatibility issue.');
    return false;
  }
}

async function testTesseractLoad() {
  addResult('Tesseract.js Load Test', 'pending', 'Attempting to load Tesseract.js library...', null);

  try {
    // Check if already loaded
    if (typeof Tesseract !== 'undefined') {
      addResult('Tesseract.js Load Test', 'pass', 'Tesseract.js is already loaded', `Version: ${Tesseract.version || 'unknown'}`);
      return true;
    }

    // Try to load dynamically
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5.0.5/dist/tesseract.min.js';
    
    return new Promise((resolve) => {
      const timeout = setTimeout(() => {
        addResult('Tesseract.js Load Test', 'fail', 'Script loading timed out after 30 seconds', null);
        addRecommendation('Tesseract.js script is timing out. This indicates:<br>1. CDN is blocked<br>2. Script is too large for network<br>3. CSP is blocking script execution<br><br><strong>Solution:</strong> Host Tesseract.js locally.');
        resolve(false);
      }, 30000);

      script.onload = () => {
        clearTimeout(timeout);
        if (typeof Tesseract !== 'undefined') {
          addResult('Tesseract.js Load Test', 'pass', 'Tesseract.js loaded successfully', `Version: ${Tesseract.version || 'unknown'}`);
          resolve(true);
        } else {
          addResult('Tesseract.js Load Test', 'fail', 'Script loaded but Tesseract object not found', 'The script loaded but did not define the global Tesseract object');
          resolve(false);
        }
      };

      script.onerror = (err) => {
        clearTimeout(timeout);
        addResult('Tesseract.js Load Test', 'fail', 'Failed to load script', err.message || 'Network error or CORS issue');
        addRecommendation('Script loading failed. Check:<br>1. Network connectivity<br>2. CORS/CSP headers<br>3. Browser console for specific errors');
        resolve(false);
      };

      document.head.appendChild(script);
    });

  } catch (err) {
    addResult('Tesseract.js Load Test', 'fail', `Error: ${err.message}`, err.stack);
    return false;
  }
}

async function runAllDiagnostics() {
  document.getElementById('diagnosticResults').innerHTML = '';
  document.getElementById('recommendations').innerHTML = '';

  addResult('Starting Diagnostics', 'pending', 'Running comprehensive system checks...', null);

  const cdnOk = await testCDN();
  const workerOk = await testWorkerSupport();
  const tesseractOk = await testTesseractLoad();

  // Summary
  const allPassed = cdnOk && workerOk && tesseractOk;
  
  if (allPassed) {
    addResult('‚úÖ All Tests Passed', 'pass', 'Your environment should work with the OCR route generator!', null);
    addRecommendation('All checks passed! If you\'re still experiencing issues:<br>1. Try the original route generator again<br>2. Clear browser cache<br>3. Check browser console for runtime errors<br>4. Ensure images are under 10MB and contain UK postcodes');
  } else {
    addResult('‚ö†Ô∏è Issues Detected', 'fail', 'Some tests failed. Review the recommendations above.', null);
    
    if (!cdnOk && !tesseractOk) {
      addRecommendation('<strong>CRITICAL: CDN Access Blocked</strong><br>You need to download Tesseract.js and host it with your application. Steps:<br>1. Download from: https://github.com/naptha/tesseract.js/releases<br>2. Extract to your project folder<br>3. Update script src to local path<br>4. Also download worker and language files');
    }
  }
}

// UK Postcode validation and parsing (no OCR)
const UK_POSTCODE_STRICT = /\b(GIR 0AA|[A-Z]{1,2}\d{1,2}[A-Z]?\s?\d[A-Z]{2})\b/i;

function testManualParsing() {
  const input = document.getElementById('manualInput').value;
  const resultsDiv = document.getElementById('manualResults');
  
  if (!input.trim()) {
    resultsDiv.innerHTML = '<div class="alert alert-warning"><span>‚ö†Ô∏è</span><span>Please enter some text with UK postcodes</span></div>';
    return;
  }

  const lines = input.split('\n').filter(l => l.trim());
  const matches = [];
  const noMatches = [];

  for (const line of lines) {
    const match = line.match(UK_POSTCODE_STRICT);
    if (match) {
      matches.push({ line, postcode: match[0] });
    } else {
      noMatches.push(line);
    }
  }

  let html = '<div style="margin-top:16px">';
  
  if (matches.length > 0) {
    html += '<div class="alert alert-success"><span>‚úÖ</span><span>Found ' + matches.length + ' lines with UK postcodes</span></div>';
    html += '<div class="diagnostic-result"><strong>Valid addresses:</strong><br>';
    matches.forEach((m, i) => {
      html += `<div style="margin:8px 0;padding:8px;background:#fff;border-radius:4px">${i + 1}. ${m.line} <span style="color:var(--success);font-weight:600">[${m.postcode}]</span></div>`;
    });
    html += '</div>';
  }

  if (noMatches.length > 0) {
    html += '<div class="alert alert-warning"><span>‚ö†Ô∏è</span><span>' + noMatches.length + ' lines without valid UK postcodes</span></div>';
    html += '<div class="diagnostic-result"><strong>Invalid/missing postcodes:</strong><br>';
    noMatches.forEach((line, i) => {
      html += `<div style="margin:8px 0;padding:8px;background:#fff;border-radius:4px;color:var(--gray-600)">${i + 1}. ${line}</div>`;
    });
    html += '</div>';
  }

  html += '<div class="alert alert-info"><span>‚ÑπÔ∏è</span><span><strong>Note:</strong> This test only validates UK postcode format. The full app would extract these from images using OCR.</span></div>';
  html += '</div>';

  resultsDiv.innerHTML = html;
}

// Auto-run basic checks on load
window.addEventListener('DOMContentLoaded', () => {
  console.log('Diagnostic tool loaded');
  console.log('Tesseract available?', typeof Tesseract !== 'undefined');
  console.log('Worker support?', typeof Worker !== 'undefined');
});
```

  </script>

  <!-- Try to load Tesseract.js (may fail, which is what we're testing) -->

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.5/dist/tesseract.min.js" onerror="console.error('Failed to load Tesseract.js from CDN')"></script>

</body>
</html>