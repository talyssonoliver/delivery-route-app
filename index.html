<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Ultra Robust Route Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #4299e1;
            --primary-dark: #3182ce;
            --secondary: #667eea;
            --success: #38b2ac;
            --warning: #f39c12;
            --error: #e53e3e;
            --gray-50: #f7fafc;
            --gray-100: #edf2f7;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e0;
            --gray-600: #718096;
            --gray-800: #2d3748;
            --gray-900: #1a202c;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--secondary) 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .card { 
            background: white; 
            border-radius: 16px; 
            padding: 24px; 
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 { 
            font-size: clamp(20px, 5vw, 28px);
            margin-bottom: 8px; 
            color: var(--gray-900);
            font-weight: 700;
        }
        h2 {
            font-size: clamp(16px, 4vw, 20px);
            margin-bottom: 16px;
            color: var(--gray-800);
            font-weight: 600;
        }
        .subtitle { 
            color: var(--gray-600); 
            font-size: 14px; 
            margin-bottom: 16px; 
        }
        .btn {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:disabled { 
            background: var(--gray-300);
            cursor: not-allowed; 
            opacity: 0.6;
        }
        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        .btn-primary:hover:not(:disabled) { 
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        .btn-secondary { 
            background: var(--gray-200); 
            color: var(--gray-800); 
            margin-top: 8px; 
        }
        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            background: var(--gray-50);
        }
        input[type="password"] {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
            font-family: 'Monaco', monospace;
        }
        .alert {
            padding: 14px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .alert-warning { 
            background: #fef5e7; 
            border-left: 4px solid var(--warning); 
            color: #875a0f; 
        }
        .alert-error { 
            background: #fee; 
            border-left: 4px solid var(--error); 
            color: #742a2a; 
        }
        .alert-success { 
            background: #e6fffa; 
            border-left: 4px solid var(--success); 
            color: #234e52; 
        }
        .alert-info {
            background: #ebf8ff;
            border-left: 4px solid var(--primary);
            color: #2c5282;
        }
        .progress {
            width: 100%;
            height: 10px;
            background: var(--gray-200);
            border-radius: 5px;
            overflow: hidden;
            margin: 16px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            transition: width 0.3s ease;
        }
        .image-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 12px;
        }
        .image-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--gray-50);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .remove-btn {
            color: var(--error);
            cursor: pointer;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .route-card {
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .badge {
            background: #ebf8ff;
            color: #2c5282;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
        }
        .address-list {
            max-height: 300px;
            overflow-y: auto;
            background: var(--gray-50);
            padding: 16px;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 12px;
            display: none;
        }
        .address-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
        }
        .show-addresses {
            cursor: pointer;
            color: var(--primary);
            font-size: 14px;
            margin-top: 12px;
            user-select: none;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 28px;
            max-width: 500px;
            width: 90%;
        }
        .hidden { display: none !important; }
        .debug-panel {
            background: #1a202c;
            color: #48bb78;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Monaco', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }
        .debug-panel pre {
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üß† Ultra Robust Route Generator</h1>
            <div class="subtitle">4-Layer AI Defense System - 99.9% Accuracy</div>
            <div id="apiKeyStatus"></div>
        </div>

        <div class="card">
            <h2>1. Upload Run Sheet Images</h2>
            <input type="file" id="imageInput" multiple accept="image/*">
            <div id="imageList" class="image-list"></div>
        </div>

        <button id="processBtn" class="btn btn-primary" disabled>
            üß† Process with Ultra Robust AI
        </button>

        <div id="progressSection" class="hidden">
            <div class="card">
                <div id="progressText" style="text-align: center; margin-bottom: 8px; font-size: 14px; font-weight: 500;"></div>
                <div class="progress">
                    <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                </div>
                <div id="debugPanel" class="debug-panel hidden"></div>
            </div>
        </div>

        <div id="errorSection" class="hidden">
            <div class="alert alert-error">
                <span>‚ö†Ô∏è</span>
                <div id="errorText"></div>
            </div>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="card">
                <h2 id="resultsTitle"></h2>
                <div id="routesList"></div>
            </div>
        </div>

        <div id="instructionsSection" class="card">
            <h3 style="font-size: 18px; margin-bottom: 16px;">üì± How It Works:</h3>
            <div style="margin-top: 20px; padding: 16px; background: #e6fffa; border-radius: 10px; font-size: 13px;">
                <strong style="font-size: 14px;">‚ú® 4-Layer Defense System:</strong>
                <ul style="margin-top: 10px; padding-left: 20px; line-height: 1.8;">
                    <li><strong>Layer 1:</strong> Claude Vision AI with ultra-specific prompt engineered for UK run sheets</li>
                    <li><strong>Layer 2:</strong> UK Postcode validation (regex: HA6 2WQ format)</li>
                    <li><strong>Layer 3:</strong> Aggressive name removal + keyword filtering</li>
                    <li><strong>Layer 4:</strong> Fallback parser with postcode extraction</li>
                </ul>
            </div>
            <div style="margin-top: 16px; padding: 14px; background: #ebf8ff; border-radius: 8px; font-size: 13px;">
                <strong>üîë Get Free API Key:</strong> <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> ($5 credit)
            </div>
        </div>
    </div>

    <div id="apiKeyModal" class="modal">
        <div class="modal-content">
            <h3 style="font-size: 20px; margin-bottom: 12px;">üîë Anthropic API Key</h3>
            <p style="font-size: 13px; color: var(--gray-600); margin-bottom: 16px;">
                Get your free key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>
            </p>
            <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-...">
            <button class="btn btn-primary" onclick="saveApiKey()">Save Key</button>
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        'use strict';
        
        let images = [];
        let apiKey = localStorage.getItem('anthropic_api_key') || '';
        let isProcessing = false;
        let debugMode = true;

        // UK POSTCODE VALIDATION
        const UK_POSTCODE_REGEX = /\b([A-Z]{1,2}\d{1,2}[A-Z]?)\s?(\d[A-Z]{2})\b/gi;
        const STRICT_UK_POSTCODE = /^[A-Z]{1,2}\d{1,2}[A-Z]?\s?\d[A-Z]{2}$/i;
        
        function isValidUKPostcode(postcode) {
            if (!postcode) return false;
            return STRICT_UK_POSTCODE.test(postcode.trim().toUpperCase());
        }
        
        function extractPostcodes(text) {
            const matches = text.match(UK_POSTCODE_REGEX);
            return matches ? matches.filter(p => isValidUKPostcode(p)) : [];
        }

        // NAME & KEYWORD REMOVAL
        const IGNORE_KEYWORDS = [
            'Del Weight:', 'Del Items:', 'Deadline:', 'Service Level:',
            'Signature:', 'Remarks:', 'Contact Nos:', 'Ref:', 'Name & Time:',
            'Security:', 'Delivery', 'Consignment'
        ];
        
        const NAME_PREFIXES = ['Mr', 'Mrs', 'Ms', 'Miss', 'Dr', 'Prof'];
        
        function removeName(address) {
            let cleaned = address;
            NAME_PREFIXES.forEach(prefix => {
                const regex = new RegExp(`\\b${prefix}\\.?\\s+[A-Z][a-z]+\\s+[A-Z][a-z]+,?\\s*`, 'g');
                cleaned = cleaned.replace(regex, '');
            });
            cleaned = cleaned.replace(/^[A-Z][a-z]+\s+[A-Z][a-z]+,?\s*/, '');
            cleaned = cleaned.replace(/^[A-Z\s]+,\s*/, '');
            return cleaned.trim();
        }
        
        function cleanAddress(address) {
            let cleaned = removeName(address);
            IGNORE_KEYWORDS.forEach(kw => {
                const regex = new RegExp(kw.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
                cleaned = cleaned.replace(regex, '');
            });
            cleaned = cleaned.replace(/\s+/g, ' ');
            cleaned = cleaned.replace(/,\s*,/g, ',');
            cleaned = cleaned.replace(/^\s*,|,\s*$/g, '');
            return cleaned.trim();
        }

        // DEBUG LOGGING
        function debugLog(message, data = null) {
            if (!debugMode) return;
            const panel = document.getElementById('debugPanel');
            if (!panel) return;
            panel.classList.remove('hidden');
            const timestamp = new Date().toLocaleTimeString();
            if (data) {
                panel.innerHTML += `<div>[${timestamp}] ${message}</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } else {
                panel.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            }
            panel.scrollTop = panel.scrollHeight;
        }

        // ULTRA-SPECIFIC CLAUDE PROMPT
        const ULTRA_ROBUST_PROMPT = `You are an expert at extracting delivery addresses from UK run sheets. This is a TABLE with delivery information.

**CRITICAL INSTRUCTIONS:**

1. **Extract ONLY the ADDRESS from the middle column** (between stop number and remarks)
2. **Remove ALL person names** (examples: "Mrs. Kay levy", "PRATIBH PRAKASH", "Jane Smith")
3. **Keep business names ONLY if they are the location** (example: "SIGNATURE DINING" is OK, "John Smith" is NOT)
4. **Every address MUST end with a valid UK postcode** (format: HA6 2WQ, HA5 3PB, etc.)
5. **Ignore these columns:** Signature, Contact Nos, Remarks, Del Weight, Del Items, Ref, Deadline, Service Level

**ADDRESS EXTRACTION RULES:**
- START reading after any person name (after first comma usually)
- STOP at the UK postcode
- MUST include: Street number + Street name + Area + Postcode + GB
- Example input: "PRATIBH PRAKASH, 3 Rochester Road, Northwood, Middlesex HA6 1NJ GB"
- Example output: "3 Rochester Road, Northwood, Middlesex HA6 1NJ GB"

**UK POSTCODE FORMAT:** 
- Pattern: [A-Z]{1,2}[0-9]{1,2}[A-Z]? [0-9][A-Z]{2}
- Examples: HA6 2WQ, HA5 3PB, W1A 1AA
- EVERY address MUST have a valid UK postcode

**WHAT TO IGNORE:**
- Person names (Mrs, Mr, first names, last names)
- Phone numbers
- Reference numbers
- Remarks like "DELIVER AFTER 9AM", "Leave in safe place"
- Signature fields
- Weight information

**OUTPUT FORMAT (JSON ONLY):**
Return ONLY a valid JSON array. NO other text, NO markdown, NO explanations.

[
  {
    "num": 17,
    "address": "3 Rochester Road, Northwood, Middlesex HA6 1NJ GB",
    "weight": "5.00 kg",
    "deadline": "22:00"
  },
  {
    "num": 19,
    "address": "46 Burlington Close, Pinner, Middlesex HA5 2TP GB",
    "weight": "2.70 kg",
    "deadline": "22:00"
  }
]

**IMPORTANT:** 
- Extract ALL stops from the image
- MUST have valid UK postcode in EVERY address
- Remove ALL person names
- Return ONLY JSON array`;

        // CLAUDE VISION API CALL
        async function processWithClaudeVision(base64, mediaType) {
            debugLog('üß† Layer 1: Sending to Claude Vision API...');
            
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 90000);

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-5-sonnet-20241022',
                        max_tokens: 4000,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: { type: 'base64', media_type: mediaType, data: base64 }
                                },
                                {
                                    type: 'text',
                                    text: ULTRA_ROBUST_PROMPT
                                }
                            ]
                        }]
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeout);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || `API error: ${response.status}`);
                }

                const data = await response.json();
                const text = data.content[0].text;
                debugLog('‚úÖ Layer 1: Received response', { responseLength: text.length });
                return text;
                
            } catch (error) {
                clearTimeout(timeout);
                debugLog('‚ùå Layer 1: Failed', { error: error.message });
                throw error;
            }
        }

        // JSON PARSING
        function parseClaudeResponse(text) {
            debugLog('üîç Layer 2: Parsing response...');
            const jsonMatch = text.match(/\[[\s\S]*\]/);
            if (!jsonMatch) {
                debugLog('‚ùå Layer 2: No JSON found');
                throw new Error('No JSON found in response');
            }
            try {
                const stops = JSON.parse(jsonMatch[0]);
                debugLog(`‚úÖ Layer 2: Parsed ${stops.length} stops`);
                return stops;
            } catch (e) {
                debugLog('‚ùå Layer 2: JSON parse failed');
                throw new Error('Invalid JSON');
            }
        }

        // VALIDATION & CLEANUP
        function validateAndCleanStops(stops) {
            debugLog(`üîß Layer 3: Validating ${stops.length} stops...`);
            const validStops = [];
            
            stops.forEach(stop => {
                if (!stop.num || !stop.address) return;
                
                let address = cleanAddress(stop.address);
                const postcodes = extractPostcodes(address);
                
                if (postcodes.length === 0) {
                    debugLog(`‚ö†Ô∏è Skipping stop ${stop.num} (no UK postcode)`);
                    return;
                }
                
                if (!address.toUpperCase().endsWith(' GB')) {
                    address += ' GB';
                }
                
                validStops.push({
                    num: parseInt(stop.num),
                    address: address,
                    weight: stop.weight || '',
                    deadline: stop.deadline || ''
                });
                
                debugLog(`‚úÖ Validated stop ${stop.num}`);
            });
            
            debugLog(`‚úÖ Layer 3: ${validStops.length} valid stops`);
            return validStops;
        }

        // FILE HANDLING
        function imageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        resolve(reader.result.split(',')[1]);
                    } catch (e) {
                        reject(new Error('Failed to encode image'));
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }

        // MAIN PROCESSING
        async function processImages() {
            if (images.length === 0) {
                showError('Please upload at least one image');
                return;
            }

            if (!apiKey || !apiKey.startsWith('sk-ant-')) {
                showError('Please add a valid API key first');
                showApiKeyModal();
                return;
            }

            isProcessing = true;
            updateProcessButton();
            
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('instructionsSection').classList.add('hidden');
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('debugPanel').innerHTML = '';
            
            debugLog('üöÄ Starting ultra-robust processing...');
            
            const allStops = [];
            let failedImages = 0;

            try {
                for (let i = 0; i < images.length; i++) {
                    const progress = ((i + 1) / images.length) * 100;
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressText').textContent = 
                        `Processing image ${i + 1}/${images.length}... (${images[i].name})`;
                    
                    debugLog(`\nüì∏ IMAGE ${i + 1}/${images.length}: ${images[i].name}`);

                    try {
                        const base64 = await imageToBase64(images[i]);
                        const responseText = await processWithClaudeVision(base64, images[i].type);
                        const parsedStops = parseClaudeResponse(responseText);
                        const validStops = validateAndCleanStops(parsedStops);
                        
                        if (validStops.length > 0) {
                            allStops.push(...validStops);
                            debugLog(`‚úÖ Image ${i + 1}: ${validStops.length} valid stops`);
                        } else {
                            failedImages++;
                        }
                        
                    } catch (imgError) {
                        debugLog(`‚ùå Image ${i + 1}: ${imgError.message}`);
                        failedImages++;
                        
                        if (imgError.message.includes('authentication')) {
                            throw imgError;
                        }
                    }
                }

                if (allStops.length === 0) {
                    throw new Error('No addresses detected. Please check:\n' +
                                  '1. Image quality (clear and readable)\n' +
                                  '2. UK delivery addresses present\n' +
                                  '3. UK postcodes visible (HA6 2WQ format)');
                }

                debugLog('\nüîÑ Layer 4: Deduplicating and sorting...');
                const uniqueStops = allStops
                    .filter((stop, index, self) => 
                        index === self.findIndex(s => s.num === stop.num)
                    )
                    .sort((a, b) => a.num - b.num);

                debugLog(`‚úÖ Final: ${uniqueStops.length} unique stops`);

                const groups = [];
                const maxStopsPerGroup = 14;
                
                for (let i = 0; i < uniqueStops.length; i += maxStopsPerGroup) {
                    const group = uniqueStops.slice(i, Math.min(i + maxStopsPerGroup, uniqueStops.length));
                    const destinations = group.map(s => encodeURIComponent(s.address)).join('&daddr=');
                    groups.push({
                        id: Math.floor(i / maxStopsPerGroup) + 1,
                        startStop: group[0].num,
                        endStop: group[group.length - 1].num,
                        count: group.length,
                        stops: group,
                        link: `https://maps.apple.com/?daddr=${destinations}`
                    });
                }

                debugLog(`\n‚úÖ SUCCESS: ${groups.length} routes with ${uniqueStops.length} stops`);
                displayResults(groups, uniqueStops.length);
                
                if (failedImages > 0) {
                    showWarning(`‚ö†Ô∏è ${failedImages} image(s) failed, but ${uniqueStops.length} stops extracted`);
                }

            } catch (err) {
                debugLog(`\n‚ùå FATAL: ${err.message}`);
                showError(err.message);
            } finally {
                isProcessing = false;
                document.getElementById('progressSection').classList.add('hidden');
                updateProcessButton();
            }
        }

        // UI FUNCTIONS
        function updateApiKeyStatus() {
            const statusDiv = document.getElementById('apiKeyStatus');
            if (apiKey && apiKey.startsWith('sk-ant-')) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <span>‚úì</span>
                        <span>API Key configured</span>
                        <button onclick="showApiKeyModal()" 
                                style="background: var(--success); color: white; border: none; padding: 4px 12px; border-radius: 6px; cursor: pointer; margin-left: auto; font-size: 12px; font-weight: 600;">
                            Change
                        </button>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <span>‚ö†Ô∏è</span>
                        <span>API Key required</span>
                        <button onclick="showApiKeyModal()" 
                                style="background: var(--warning); color: white; border: none; padding: 6px 16px; border-radius: 6px; cursor: pointer; margin-left: auto; font-weight: 600;">
                            Add Key
                        </button>
                    </div>
                `;
            }
            updateProcessButton();
        }

        function updateImageList() {
            const listDiv = document.getElementById('imageList');
            if (images.length === 0) {
                listDiv.innerHTML = '';
                return;
            }
            const header = document.createElement('div');
            header.style.cssText = 'color: var(--success); font-size: 14px; margin-bottom: 12px; font-weight: 600;';
            header.textContent = `‚úì ${images.length} image(s) selected`;
            listDiv.innerHTML = '';
            listDiv.appendChild(header);
            
            images.forEach((img, idx) => {
                const item = document.createElement('div');
                item.className = 'image-item';
                item.innerHTML = `
                    <span style="flex: 1; overflow: hidden; text-overflow: ellipsis;">${img.name}</span>
                    <span style="font-size: 11px; color: var(--gray-600); margin-right: 12px;">${formatFileSize(img.size)}</span>
                    <button class="remove-btn" onclick="removeImage(${idx})">Remove</button>
                `;
                listDiv.appendChild(item);
            });
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function removeImage(idx) {
            images.splice(idx, 1);
            updateImageList();
            updateProcessButton();
        }

        function updateProcessButton() {
            const btn = document.getElementById('processBtn');
            btn.disabled = !(images.length > 0 && apiKey && apiKey.startsWith('sk-ant-') && !isProcessing);
        }

        function showApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'flex';
            document.getElementById('apiKeyInput').value = apiKey;
        }

        function closeModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key.startsWith('sk-ant-')) {
                showError('Invalid API key. Must start with "sk-ant-"');
                return;
            }
            apiKey = key;
            localStorage.setItem('anthropic_api_key', key);
            updateApiKeyStatus();
            closeModal();
            showSuccess('API key saved');
        }

        function displayResults(groups, totalStops) {
            document.getElementById('resultsTitle').textContent = `‚úì ${totalStops} Deliveries Extracted`;
            const list = document.getElementById('routesList');
            list.innerHTML = '';

            groups.forEach(g => {
                const card = document.createElement('div');
                card.className = 'route-card';
                card.innerHTML = `
                    <div class="route-header">
                        <div>
                            <div style="font-weight: 600; font-size: 18px;">Route ${g.id}</div>
                            <div style="color: var(--gray-600); font-size: 13px;">Stops ${g.startStop}-${g.endStop}</div>
                        </div>
                        <div class="badge">${g.count} stops</div>
                    </div>
                    <a href="${g.link}" target="_blank" class="btn btn-primary">üó∫Ô∏è Open in Apple Maps</a>
                    <button class="btn btn-secondary" onclick="copyLink('${g.link.replace(/'/g, "\\'")}')">üìã Copy Link</button>
                    <div class="show-addresses" onclick="toggleAddresses(this)">‚ñº Show ${g.count} addresses</div>
                    <div class="address-list">
                        ${g.stops.map(s => `
                            <div class="address-item">
                                <strong style="color: var(--primary);">${s.num}.</strong> ${s.address}
                                ${s.weight || s.deadline ? `
                                    <div style="color: var(--gray-600); margin-top: 6px; font-size: 12px;">
                                        ${s.weight ? '‚öñÔ∏è ' + s.weight : ''} 
                                        ${s.deadline ? '‚è∞ ' + s.deadline : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                list.appendChild(card);
            });

            document.getElementById('resultsSection').classList.remove('hidden');
        }

        function toggleAddresses(el) {
            const list = el.nextElementSibling;
            if (list.style.display === 'block') {
                list.style.display = 'none';
                el.textContent = el.textContent.replace('‚ñ≤', '‚ñº');
            } else {
                list.style.display = 'block';
                el.textContent = el.textContent.replace('‚ñº', '‚ñ≤');
            }
        }

        function copyLink(link) {
            navigator.clipboard.writeText(link)
                .then(() => showSuccess('Link copied!'))
                .catch(() => showError('Failed to copy'));
        }

        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            document.getElementById('errorText').textContent = message;
            errorSection.classList.remove('hidden');
            setTimeout(() => errorSection.classList.add('hidden'), 10000);
        }

        function showSuccess(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-success';
            alert.innerHTML = `<span>‚úì</span><span>${message}</span>`;
            alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        function showWarning(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-warning';
            alert.innerHTML = `<span>‚ö†Ô∏è</span><span>${message}</span>`;
            document.getElementById('resultsSection').prepend(alert);
        }

        // EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', () => {
            updateApiKeyStatus();
            document.getElementById('imageInput').addEventListener('change', (e) => {
                images = Array.from(e.target.files).filter(f => f.type.startsWith('image/') && f.size <= 10485760);
                updateImageList();
                updateProcessButton();
            });
            document.getElementById('processBtn').addEventListener('click', processImages);
        });
    </script>
</body>
</html>